<!DOCTYPE html>
<html>
<head>
<title>System Metrics Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.css">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: "Hack", monospace;
    background: #0d1117;
    color: #c9d1d9;
    padding: 20px;
    height: 100vh;
  }
  
  .header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  h1 {
    font-size: 32px;
    font-weight: 600;
    color: #58a6ff;
    margin-bottom: 10px;
    margin-top: 3%;
  }
  
  .status {
    font-size: 14px;
    color: #8b949e;
  }
  
  .status.connected {
    color: #3fb950;
  }
  
  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    max-width: 90vw;
    margin: 0 auto;
  }
  
  .chart-container {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    position: relative;
    height: 350px;
  }
  
  .chart-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    color: #c9d1d9;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .current-value {
    font-size: 24px;
    font-weight: 700;
    color: #58a6ff;
  }
  
  canvas {
    height: 280px !important;
  }
  
  @media (max-width: 1200px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
</head>
<body>

<div class="header">
  <h1>System Metrics Dashboard</h1>
  <div class="status" id="status">‚ö™ Connecting...</div>
</div>

<div class="grid">
  <div class="chart-container">
    <div class="chart-title">
      CPU Usage
      <span class="current-value" id="cpu-value">0%</span>
    </div>
    <canvas id="cpuChart"></canvas>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">
      Memory Usage
      <span class="current-value" id="mem-value">0%</span>
    </div>
    <canvas id="memChart"></canvas>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">
      Disk Usage
      <span class="current-value" id="disk-value">0%</span>
    </div>
    <canvas id="diskChart"></canvas>
  </div>
  
  <div class="chart-container">
    <div class="chart-title">
      Network Traffic
      <span class="current-value" id="net-value">0 KB/s</span>
    </div>
    <canvas id="netChart"></canvas>
  </div>
</div>

<script>
const MAX_POINTS = 200;
const WINDOW_DURATION = 60000; // 60 seconds

const commonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  animation: false,
  interaction: {
    mode: 'nearest',
    axis: 'x',
    intersect: false
  },
  scales: {
    x: {
      type: "time",
      time: {
        tooltipFormat: "HH:mm:ss",
        displayFormats: {
          second: "HH:mm:ss",
          minute: "HH:mm"
        }
      },
      ticks: {
        maxRotation: 0,
        autoSkipPadding: 20,
        color: '#8b949e'
      },
      grid: {
        color: 'rgba(139, 148, 158, 0.1)'
      }
    },
    y: {
      min: 0,
      ticks: {
        color: '#8b949e'
      },
      grid: {
        color: 'rgba(139, 148, 158, 0.1)'
      }
    }
  },
  plugins: {
    legend: {
      display: false
    },
    tooltip: {
      mode: 'nearest',
      intersect: false,
      backgroundColor: 'rgba(22, 27, 34, 0.95)',
      titleColor: '#c9d1d9',
      bodyColor: '#c9d1d9',
      borderColor: '#30363d',
      borderWidth: 1
    }
  }
};

const cpuChart = new Chart(document.getElementById("cpuChart"), {
  type: "line",
  data: {
    datasets: [{
      label: "CPU %",
      data: [],
      borderColor: "rgb(88, 166, 255)",
      backgroundColor: "rgba(88, 166, 255, 0.1)",
      borderWidth: 2,
      tension: 0.4,
      pointRadius: 0,
      fill: true
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      ...commonOptions.scales,
      y: {
        ...commonOptions.scales.y,
        max: 100,
        ticks: {
          ...commonOptions.scales.y.ticks,
          callback: (value) => value + '%'
        }
      }
    }
  }
});

const memChart = new Chart(document.getElementById("memChart"), {
  type: "line",
  data: {
    datasets: [{
      label: "Memory %",
      data: [],
      borderColor: "rgb(163, 113, 247)",
      backgroundColor: "rgba(163, 113, 247, 0.1)",
      borderWidth: 2,
      tension: 0.4,
      pointRadius: 0,
      fill: true
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      ...commonOptions.scales,
      y: {
        ...commonOptions.scales.y,
        max: 100,
        ticks: {
          ...commonOptions.scales.y.ticks,
          callback: (value) => value + '%'
        }
      }
    }
  }
});

const diskChart = new Chart(document.getElementById("diskChart"), {
  type: "line",
  data: {
    datasets: [{
      label: "Disk %",
      data: [],
      borderColor: "rgb(242, 139, 130)",
      backgroundColor: "rgba(242, 139, 130, 0.1)",
      borderWidth: 2,
      tension: 0.4,
      pointRadius: 0,
      fill: true
    }]
  },
  options: {
    ...commonOptions,
    scales: {
      ...commonOptions.scales,
      y: {
        ...commonOptions.scales.y,
        max: 100,
        ticks: {
          ...commonOptions.scales.y.ticks,
          callback: (value) => value + '%'
        }
      }
    }
  }
});

const netChart = new Chart(document.getElementById("netChart"), {
  type: "line",
  data: {
    datasets: [
      {
        label: "Download",
        data: [],
        borderColor: "rgb(63, 185, 80)",
        backgroundColor: "rgba(63, 185, 80, 0.1)",
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 0,
        fill: true
      },
      {
        label: "Upload",
        data: [],
        borderColor: "rgb(255, 191, 0)",
        backgroundColor: "rgba(255, 191, 0, 0.1)",
        borderWidth: 2,
        tension: 0.4,
        pointRadius: 0,
        fill: true
      }
    ]
  },
  options: {
    ...commonOptions,
    plugins: {
      ...commonOptions.plugins,
      legend: {
        display: true,
        labels: {
          color: '#8b949e',
          usePointStyle: true,
          padding: 15
        }
      }
    },
    scales: {
      ...commonOptions.scales,
      y: {
        ...commonOptions.scales.y,
        ticks: {
          ...commonOptions.scales.y.ticks,
          callback: (value) => value.toFixed(1) + ' KB/s'
        }
      }
    }
  }
});

const charts = {
  cpu: cpuChart,
  mem: memChart,
  disk: diskChart,
  net: netChart
};

function updateChartRange(chart) {
  const data = chart.data.datasets[0].data;
  if (data.length === 0) return;
  
  const latestTime = data[data.length - 1].x;
  const earliestTime = Math.max(
    data[0] ? data[0].x : latestTime,
    latestTime - WINDOW_DURATION
  );
  
  chart.options.scales.x.min = earliestTime;
  chart.options.scales.x.max = latestTime;
}

fetch("http://127.0.0.1:8000/metrics")
  .then(r => r.json())
  .then(rows => {
    rows.reverse();
    for (const row of rows) {
      const ts = new Date(row[2]).getTime();
      
      cpuChart.data.datasets[0].data.push({ x: ts, y: row[3] });
      memChart.data.datasets[0].data.push({ x: ts, y: row[4] });
      diskChart.data.datasets[0].data.push({ x: ts, y: row[5] });
      netChart.data.datasets[0].data.push({ x: ts, y: row[6] });
      netChart.data.datasets[1].data.push({ x: ts, y: row[7] });
    }
    
    Object.values(charts).forEach(chart => {
      updateChartRange(chart);
      chart.update('none');
    });
  })
  .catch(err => console.error("Error loading initial data:", err));

const es = new EventSource("http://127.0.0.1:8000/stream");

es.onopen = () => {
  console.log("‚úÖ SSE connection opened");
  document.getElementById('status').textContent = 'üü¢ Connected';
  document.getElementById('status').className = 'status connected';
};

es.onmessage = (e) => {
  const row = JSON.parse(e.data);
  const ts = new Date(row.ts).getTime();
  
  // Add new data points
  cpuChart.data.datasets[0].data.push({ x: ts, y: row.cpu });
  memChart.data.datasets[0].data.push({ x: ts, y: row.mem });
  diskChart.data.datasets[0].data.push({ x: ts, y: row.disk });
  netChart.data.datasets[0].data.push({ x: ts, y: row.bytes_recv });
  netChart.data.datasets[1].data.push({ x: ts, y: row.bytes_send });
  
  // Update current values
  document.getElementById('cpu-value').textContent = row.cpu.toFixed(1) + '%';
  document.getElementById('mem-value').textContent = row.mem.toFixed(1) + '%';
  document.getElementById('disk-value').textContent = row.disk.toFixed(1) + '%';
  document.getElementById('net-value').textContent = 
    `‚Üì${row.bytes_recv.toFixed(1)} ‚Üë${row.bytes_send.toFixed(1)} KB/s`;
  
  Object.values(charts).forEach(chart => {
    chart.data.datasets.forEach(dataset => {
      const cutoffTime = ts - WINDOW_DURATION;
      while (dataset.data.length > 0 && dataset.data[0].x < cutoffTime) {
        dataset.data.shift();
      }
      if (dataset.data.length > MAX_POINTS) {
        dataset.data.shift();
      }
    });
    
    updateChartRange(chart);
    chart.update('none');
  });
};

es.onerror = (err) => {
  console.error("‚ùå EventSource error:", err);
  document.getElementById('status').textContent = 'üî¥ Disconnected';
  document.getElementById('status').className = 'status';
};
</script>
</body>
</html>